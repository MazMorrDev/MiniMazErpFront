<div class="mov-inv-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>Inventory Movements</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Form Section -->
      <form [formGroup]="form" (ngSubmit)="add()" class="mov-form">
        <div class="form-grid">
          @if (products().length > 0) {
          <mat-form-field appearance="outline">
            <mat-label>Product</mat-label>
            <mat-select formControlName="productId">
              <mat-option [value]="null">-- Choose Product --</mat-option>
              @for (p of products(); track p.id) {
              <mat-option [value]="p.id">{{ p.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
          } @else {
          <mat-form-field appearance="outline">
            <mat-label>Product Name</mat-label>
            <input matInput type="text" placeholder="Enter product name" formControlName="productName">
          </mat-form-field>
          }

          <mat-form-field appearance="outline">
            <mat-label>Type</mat-label>
            <mat-select formControlName="type">
              <mat-option value="IN">IN</mat-option>
              <mat-option value="OUT">OUT</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Quantity</mat-label>
            <input matInput type="number" min="1" formControlName="quantity">
            @if (form.get('quantity')?.hasError('min')) {
            <mat-error>Quantity must be at least 1</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Date</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="date">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Notes</mat-label>
            <textarea matInput formControlName="notes" rows="2"></textarea>
          </mat-form-field>

          <div class="form-actions">
            <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid">
              <mat-icon>add</mat-icon> Record Movement
            </button>
            <button mat-button type="button" (click)="resetForm()">
              <mat-icon>clear</mat-icon> Clear
            </button>
          </div>
        </div>
      </form>

      <!-- Filters Section -->
      <mat-card class="filters-card">
        <mat-card-header>
          <mat-card-title>Filters</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="filters-grid">
            <mat-form-field appearance="outline">
              <mat-label>Filter by product</mat-label>
              <mat-select [value]="filters()" (selectionChange)="updateFilterProductId($event.value)">
                <mat-option [value]="undefined">All Products</mat-option>
                @for (p of products(); track p.id) {
                <mat-option [value]="p.id">{{ p.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <div class="filter-actions">
              <!-- ELIMINADO: BotÃ³n "Apply Filters" ya no es necesario -->
              <button mat-button (click)="clearFilters()">
                <mat-icon>clear_all</mat-icon> Clear Filters
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- History Section with @defer -->
      @defer (on viewport) {
      <mat-card class="history-card">
        <mat-card-header>
          <mat-card-title>Movement History</mat-card-title>
          <mat-card-subtitle>Total: {{ filteredMovements().length }} movements</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          @if (filteredMovements().length > 0) {
          <div class="table-container">
            <table mat-table [dataSource]="filteredMovements()" class="mat-elevation-z2">
              <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let movement">
                  {{ movement.date | date:'medium' }}
                </td>
              </ng-container>

              <ng-container matColumnDef="productName">
                <th mat-header-cell *matHeaderCellDef>Product</th>
                <td mat-cell *matCellDef="let movement">{{ movement.productName }}</td>
              </ng-container>

              <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef>Type</th>
                <td mat-cell *matCellDef="let movement">
                  <span [class]="'type-badge ' + (movement.type === 'IN' ? 'type-in' : 'type-out')">
                    {{ movement.type }}
                  </span>
                </td>
              </ng-container>

              <ng-container matColumnDef="quantity">
                <th mat-header-cell *matHeaderCellDef>Quantity</th>
                <td mat-cell *matCellDef="let movement">{{ movement.quantity }}</td>
              </ng-container>

              <ng-container matColumnDef="notes">
                <th mat-header-cell *matHeaderCellDef>Notes</th>
                <td mat-cell *matCellDef="let movement">
                  {{ movement.notes || '-' }}
                </td>
              </ng-container>

              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let movement">
                  <button mat-icon-button color="warn" matTooltip="Delete" (click)="remove(movement)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
          </div>
          } @else {
          <div class="no-data">
            <mat-icon>inventory_2</mat-icon>
            <p>No movements found</p>
          </div>
          }
        </mat-card-content>
      </mat-card>
      } @placeholder {
      <div class="placeholder">
        <!-- CAMBIO: Usar mat-spinner correctamente -->
        <mat-spinner [diameter]="40"></mat-spinner>
        <p>Loading movement history...</p>
      </div>
      } @loading (minimum 500ms) {
      <div class="placeholder">
        <mat-spinner [diameter]="40"></mat-spinner>
        <p>Loading movement history...</p>
      </div>
      }
    </mat-card-content>
  </mat-card>
</div>